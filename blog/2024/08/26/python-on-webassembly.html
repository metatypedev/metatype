<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-blog" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Python on WebAssembly: How? | Metatype</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://metatype.dev/blog/2024/08/26/python-on-webassembly"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Python on WebAssembly: How? | Metatype"><meta data-rh="true" name="description" content="Metatype&#x27;s different language runtimes are nice, but integrating one is an entire story. Let&#x27;s discover how we managed to implement one for Python."><meta data-rh="true" property="og:description" content="Metatype&#x27;s different language runtimes are nice, but integrating one is an entire story. Let&#x27;s discover how we managed to implement one for Python."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-08-26T00:00:00.000Z"><link data-rh="true" rel="icon" href="/images/favicon.ico"><link data-rh="true" rel="canonical" href="https://metatype.dev/blog/2024/08/26/python-on-webassembly"><link data-rh="true" rel="alternate" href="https://metatype.dev/blog/2024/08/26/python-on-webassembly" hreflang="en"><link data-rh="true" rel="alternate" href="https://metatype.dev/blog/2024/08/26/python-on-webassembly" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://metatype.dev/blog/2024/08/26/python-on-webassembly","mainEntityOfPage":"https://metatype.dev/blog/2024/08/26/python-on-webassembly","url":"https://metatype.dev/blog/2024/08/26/python-on-webassembly","headline":"Python on WebAssembly: How?","name":"Python on WebAssembly: How?","description":"Metatype's different language runtimes are nice, but integrating one is an entire story. Let's discover how we managed to implement one for Python.","datePublished":"2024-08-26T00:00:00.000Z","author":[],"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://metatype.dev/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Metatype RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Metatype Atom Feed">






<link rel="preconnect" href="https://eu.posthog.com">
<script>!function(t,e){var o,p,i,n;e.__SV||(window.posthog=e,e._i=[],e.init=function(r,s,c){function a(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(i=t.createElement("script")).type="text/javascript",i.async=!0,i.src=s.api_host+"/static/array.js",(n=t.getElementsByTagName("script")[0]).parentNode.insertBefore(i,n);var u=e;for(void 0!==c?u=e[c]=[]:c="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==c&&(e+="."+c),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset".split(" "),p=0;p<o.length;p++)a(u,o[p]);e._i.push([r,s,c])},e.__SV=1)}(document,window.posthog||[]),posthog.init("phc_xeoqjAATkOtdpBmixBDIbLp6wCDSo87kAjdKCILQc8U",{api_host:"https://eu.posthog.com",persistence:"memory",id:"default"})</script>



<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&amp;display=swap"><link rel="stylesheet" href="/assets/css/styles.1dcfc16d.css">
<script src="/assets/js/runtime~main.1901cb6e.js" defer="defer"></script>
<script src="/assets/js/main.35bb5011.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_kkJt" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/images/logo.svg" alt="Metatype Logo" class="themedComponent_Ev3p themedComponent--light_IPMc"><img src="/images/logo.svg" alt="Metatype Logo" class="themedComponent_Ev3p themedComponent--dark_olOz"></div><b class="navbar__title text--truncate">Metatype</b></a><a class="navbar__item navbar__link" href="/use-cases/automatic-crud-validation">Use cases</a><a class="navbar__item navbar__link" href="/docs/concepts/features-overview">Features</a><a class="navbar__item navbar__link" href="/docs">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/metatypedev/metatype" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><a href="https://communityinviter.com/apps/metatypedev/invite" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-slack-link"></a><div class="navbarSearchContainer_YXBI"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_Ge4w"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_lQgi thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_mx0m margin-bottom--md">Recent posts</div><ul class="sidebarItemList_r_qu clean-list"><li class="sidebarItem_bvrZ"><a class="sidebarItemLink_DrpT" href="/blog/2024/09/26/introducing-grpc-runtime">Introducing gRPC Runtime</a></li><li class="sidebarItem_bvrZ"><a class="sidebarItemLink_DrpT" href="/blog/2024/08/27/distributed-execution-flow-paradigms">Distributed execution flow paradigms</a></li><li class="sidebarItem_bvrZ"><a aria-current="page" class="sidebarItemLink_DrpT sidebarItemLinkActive_QiP1" href="/blog/2024/08/26/python-on-webassembly">Python on WebAssembly: How?</a></li><li class="sidebarItem_bvrZ"><a class="sidebarItemLink_DrpT" href="/blog/2024/05/09/programmatic-deployment">Programmatic deployment (v0.4.x)</a></li><li class="sidebarItem_bvrZ"><a class="sidebarItemLink_DrpT" href="/blog/2023/11/27/node-compatibility">The Node/Deno SDK is now available</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="title_vgDZ">Python on WebAssembly: How?</h1><div class="container_h3HB margin-vert--md"><time datetime="2024-08-26T00:00:00.000Z">August 26, 2024</time> · <!-- -->12 min read</div></header><div id="__blog-post-container" class="markdown"><p>Metatype&#x27;s different language runtimes are nice, but integrating one is an entire story. Let&#x27;s discover how we managed to implement one for Python.</p>
<h2 class="anchor anchorWithStickyNavbar_gmPS" id="why">Why?<a class="hash-link" aria-label="Direct link to Why?" title="Direct link to Why?" href="/blog/2024/08/26/python-on-webassembly#why">​</a></h2>
<p>You have probably heard of &quot;Function as a Service&quot; or FaaS.
In simple terms, FaaS are platforms that allow users to run code in response to events without the hassle of managing the underlying infrastructure.
Users submit their programs and the platform takes care of the rest including, usually, scaling, availability, and configuration.
AWS Lambda is one such example and FaaS as a whole are a popular implementation of the serverless model.</p>
<p>Metatype has this model at heart with applications composed of small functions that respond to events like http requests and authorization checks.
This is achieved through runtimes like the <a href="/docs/reference/runtimes/deno"><code>DenoRuntime</code></a> which implements a way to execute functions authored in Typescript using Web Workers as implemented by <a href="https://docs.deno.com/runtime/manual/runtime/workers/" target="_blank" rel="noopener noreferrer">Deno</a> (not based on Deno Deploy).</p>
<div class="theme-admonition theme-admonition-note admonition_YYWW alert alert--secondary"><div class="admonitionHeading_vFJj"><span class="admonitionIcon_OgGg"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_rC2G"><p>Metatype supports running multiple apps or typegraphs on a single deployed cluster but we&#x27;re still in the kitchen on a hosted cloud solution.
Subscribe to the <a href="https://metatype.dev/blog/rss.xml" target="_blank" rel="noopener noreferrer">blog</a> or the <a href="https://github.com/metatypedev/metatype" target="_blank" rel="noopener noreferrer">Github</a> repository for updates.</p></div></div>
<p>Implementing the <code>DenoRuntime</code> was a very straightforward affair as the Typegate (the engine at the heart of Metatype) is primarily written in Typescript and runs on a slightly modified version of the Deno runtime.
What&#x27;s more, JavaScript has single threaded and asynchronous semantics and the v8 engine that it commonly runs on is of very high-quality by all regards.
These qualities lend themselves very well to the requirements of running a serverless platform like security (good sandboxing) and performance (low start-up latencies).
This fact is reflected in the dominance of JavaScript in the serverless market though it doesn&#x27;t hurt that it&#x27;s also the most popular language in use today.</p>
<p>Another very popular language is Python; and its standard library can be quite resourceful for this type of use case.
However, as we shall see, integrating the Python runtime isn&#x27;t as simple as integrating Deno.</p>
<h2 class="anchor anchorWithStickyNavbar_gmPS" id="what-are-the-requirements">What are the requirements?<a class="hash-link" aria-label="Direct link to What are the requirements?" title="Direct link to What are the requirements?" href="/blog/2024/08/26/python-on-webassembly#what-are-the-requirements">​</a></h2>
<p>There are a number of Python runtimes available but a set of extra factors limit what we can achieve.</p>
<ol>
<li><strong>Security</strong>: functions should have limited access to the execution environment. Python doesn&#x27;t have built-in features for sandboxing out of the box unlike Deno.</li>
<li><strong>Speed</strong>: functions should run fast and with low latency. We&#x27;re interested in metrics like cold-start latency and overhead of any cross process/system communication.</li>
<li><strong>User-friendliness</strong>: functionalities provided in any of the languages supported by Metatype should, within reason, mirror each other and maintain a degree of uniformity. We support inline code snippets and external file references for <code>DenoRuntime</code> and this should be the case for Python as well.</li>
<li><strong>Interoperability</strong>: functions running in Python will need to have access to other parts of the app running on the Typegate like being able to invoke other functions.</li>
</ol>
<p>The Typegate is a TypeScript program with a bit of Rust sprinkled in.
It runs as a traditional POSIX process.
Think Linux containers.
This fact renders multi-processing, one of the readily apparent approaches, undesirable as it would require investing is robust worker process management and distribution schemes.
It&#x27;d be great if we could keep everything inside the Typegate process.</p>
<p>One solution that presents itself here is the <a href="https://pyo3.rs/" target="_blank" rel="noopener noreferrer">PyO3</a> project which provide Rust bindings to different Python runtimes like CPython and PyPy.
It&#x27;d not only allow us to run Python code in-process but it also provide an easy way to expose the functions written in Rust to Python and vice-versa.
A good solution for the bidirectional communication needed for our interoperability requirements.</p>
<p>Unfortunately, PyO3 doesn&#x27;t have any provisions for sandboxing which is critical for our use case.
This is where WebAssembly enters into the picture.
WebAssembly or Wasm for short is a executable bytecode format that originates from the web world and is designed for applications that run inside web-browsers.
This use case shares most of our requirements and the Wasm world promises excellent sandboxing properties that should be perfect for our use case.
We just have to find a way to run Python inside of it.</p>
<h2 class="anchor anchorWithStickyNavbar_gmPS" id="an-aside-on-wasi">An aside on WASI<a class="hash-link" aria-label="Direct link to An aside on WASI" title="Direct link to An aside on WASI" href="/blog/2024/08/26/python-on-webassembly#an-aside-on-wasi">​</a></h2>
<p>WebAssembly System Interface (WASI) is an additional spec for the bytecode format that formalizes how Wasm programs access their host environment.
A lot like POSIX, this generally means OS capabilities such as file system access and networking but also, in it&#x27;s latest iteration extends to any custom host defined functionality.</p>
<p>Wasm + WASI fits very well to our use case. As opposed to mutli-processing, we can instantiate, manage, and expose resources programmatically with ease.
And as luck would have it, some <a href="https://github.com/vmware-labs/webassembly-language-runtimes" target="_blank" rel="noopener noreferrer">community work</a> has already been done at the time that led to wasm builds of CPython being available.</p>
<p>Unfortunately, the WASI spec itself is a work in progress.
When we started out, only the limited &quot;<a href="https://github.com/WebAssembly/WASI/blob/main/legacy/preview1/docs.md" target="_blank" rel="noopener noreferrer">preview1</a>&quot; implementation was supported by most runtimes.
<code>preview1</code> only focused on a standard set of host functionalities much like a <code>libc</code> implementation.
Well enough but any custom functionality meant having to rely on simple C ABI alike functions for <em>intra</em>-process communication.
In order to make this work easier, we elected to bring PyO3 back into the picture so that all the IPC stuff is written in Rust, the language with the most support in the Wasm ecosystem today.</p>
<p>All in all, this would mean the python interpreter wrapped in a PyO3 based native API.
An assembly that accepts user code as strings and then invokes them in response to events.
All of this would be running inside a Wasm runtime, <a href="https://wasmedge.org/" target="_blank" rel="noopener noreferrer">WasmEdge</a> in this case, which ticks of all of the sandboxing and security requirements.
This approach is well described as the <a href="https://wasmcloud.com/blog/webassembly-patterns-command-reactor-library#the-reactor-pattern" target="_blank" rel="noopener noreferrer">Reactor pattern</a>, a common pattern used in Wasm land.</p>
<img src="/images/wasi_vfs_python_and_rust.svg" alt="FIRST SOLUTION">
<h3 class="anchor anchorWithStickyNavbar_gmPS" id="file-system-access">File system access<a class="hash-link" aria-label="Direct link to File system access" title="Direct link to File system access" href="/blog/2024/08/26/python-on-webassembly#file-system-access">​</a></h3>
<p>Since the PyO3 project doesn&#x27;t support <a href="https://github.com/PyO3/pyo3/issues/416" target="_blank" rel="noopener noreferrer">statically linking</a> the Python runtime, we&#x27;ll need to find a way dynamically link <code>libpython</code>.
Thankfully, Wasm does support <a href="https://github.com/WebAssembly/design/blob/main/DynamicLinking.md" target="_blank" rel="noopener noreferrer">dynamic linking</a> and wasm builds of <a href="https://github.com/vmware-labs/webassembly-language-runtimes/tree/main/python" target="_blank" rel="noopener noreferrer"><code>libpython</code></a> are available curtsy of the WebAssembly Language Runtimes project.
Bringing all of this together isn&#x27;t as simple though as PyO3&#x27;s tries to load <code>libpython</code> from certain <em>paths</em>, a concept that isn&#x27;t exactly clearly defined in Wasm&#x27;s post POSIX webtopia.</p>
<p>Our first solution was to use <a href="https://github.com/kateinoigakukun/wasi-vfs" target="_blank" rel="noopener noreferrer">wasi-vfs</a>, a tool which allows you to embed a virtual file system, accessible through preview1 APIs, directly into your wasm binaries.
This way, we could prepare a single wasm artifact that contains both the <code>libpython</code> build and the custom glue code.</p>
<p>This approach turned out to be quite hacky though and after encountering several issues, we ultimately decided to go with <strong>preopens</strong>.
Preopens are another virtual file-system solution where you map an actual file-system directory to a virtual directory visible to a running Wasm instance.
This means we&#x27;ll need to prepare the <code>libpython</code> Wasm file on disk before running the instance but it was an acceptable solution.
We also use preopens to provide some of the user submitted code to our custom python runtime.</p>
<p>The following rust snippet demonstrates the preopens looked like in use:</p>
<div class="language-rust codeBlockContainer_yjWX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_uZxP"><pre tabindex="0" class="prism-code language-rust codeBlock_Af8L thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_YPc1"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">init_Python_vm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Rt</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> preopens </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">vec!</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// User script will be uploaded at ./src/Python which is virtually seen as /app</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Each script has access only to /app</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;/app:./src/Python:readonly&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">to_owned</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// This follow the same idea as above, but for clarity&#x27;s sake we decided to separate it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> pylib </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">PathBuf</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./vendor/libpython/usr/local/lib&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// This is our wasm module reponsible for running Python scripts at runtime</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// It assumes /app and libpython to be available in its world</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> wasi_mod </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">PathBuf</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./build/Python-wasi-reactor.wasm&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Now we can instantiate the WASI module with all the configurations above</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> rt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">instantiate_custom_python_runtime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">preopens</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pylib</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> wasi_mod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">run_func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;init_Python&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">params!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_oEkQ"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_P8GA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_t89q"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_x1PT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_gmPS" id="wasi-02">WASI 0.2<a class="hash-link" aria-label="Direct link to WASI 0.2" title="Direct link to WASI 0.2" href="/blog/2024/08/26/python-on-webassembly#wasi-02">​</a></h3>
<p>The solution described above worked well to an extent but the limitations of preview1 and all the wrangling with PyO3 resulted in complexity that we were always ready to get rid of.
This was exactly what we did after the Bytecode Alliance finalized <a href="https://bytecodealliance.org/articles/WASI-0.2" target="_blank" rel="noopener noreferrer">WASI 0.2</a> back in January 2024 and with it, a slew of new opportunuties.</p>
<p>WASI 0.2 introduces a whole new concept of components, wasm modules that come with pre-specifed interfaces using the <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/WIT.md" target="_blank" rel="noopener noreferrer">Wit</a> format and based on a whole new <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md" target="_blank" rel="noopener noreferrer">ABI</a> to boot.
These new capabilities suggest that it should possible to replace our PyO3 based glue code with the WASI based layer.
Let&#x27;s see how.</p>
<p>We first used the new found WASI powers to implement support for Wasm based functions through the <a href="/docs/reference/runtimes/wasm"><code>WasmRuntime</code></a>.
This lead us to implement the <a href="https://github.com/metatypedev/metatype/blob/2e692b9ae9e48b6e1a863130fc1bfbdd004cb631/src/wit/wit-wire.wit" target="_blank" rel="noopener noreferrer"><code>wit_wire</code></a> protocol, a simple JSON based WIT interface that&#x27;d be used by any wasm component that intenteds to run on the <code>WasmRuntime</code>.
Simple enough that it&#x27;s reproduced down below in it&#x27;s entirety.</p>
<div class="language-wit codeBlockContainer_yjWX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_uZxP"><pre tabindex="0" class="prism-code language-wit codeBlock_Af8L thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_YPc1"><span class="token-line" style="color:#393A34"><span class="token plain">package metatype:wit-wire;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// what the host provides</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">interface typegate-wire {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hostcall: func(op-name: string, json: string) -&gt; result&lt;string, string&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// what&#x27;s expected from the guest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">interface mat-wire {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // init function called when we first make the component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  init: func(args: init-args) -&gt; result&lt;init-response, init-error&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // general purpose event handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  handle: func(req: handle-req) -&gt; result&lt;json-str, handle-err&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type json-str = string;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record init-args {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // the list of operations the application is expecting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // from this component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    expected-ops: list&lt;mat-info&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metatype-version: string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record mat-info {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    op-name: string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mat-title: string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mat-data-json: string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record init-response {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ok: bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  variant init-error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    version-mismatch(string),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unexpected-mat(mat-info),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    other(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record handle-req {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    op-name: string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    in-json: json-str,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  variant handle-err {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    no-handler,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    in-json-err(string),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    handler-err(string),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// a world defines what interfaces get imported</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// and exported</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">world wit-wire {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  import typegate-wire;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  export mat-wire;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_oEkQ"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_P8GA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_t89q"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_x1PT"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Squint your eyes tight enough and the <code>wit_wire</code> protocol as implemented wasn&#x27;t far off from what the PyO3 based glue code was doing in the previous implementation.
Specifically, register a list of operations that the Typegate is expecting from the module and execute them for incoming event.
We just need to add support for the operation metadata to contain extra items.
In the case of the <a href="/docs/reference/runtimes/python"><code>PythonRuntime</code></a>, this would be the Python code itself.</p>
<p>Now that we have the <code>wit_wire</code> implementation taking care of bidirectional communication, we have little reason to keep the PyO3 based glue code around.
This glue was doing a bit more than acting as a boundary though.
It was also responsible for setting up the operating environment for the Python code.
For example, we&#x27;d need some kind of initialization to execute the user&#x27;s Python snippets which are in free standing <code>lambda</code> form.
How does one create components out of Python anyways?</p>
<p><a href="https://github.com/bytecodealliance/componentize-py" target="_blank" rel="noopener noreferrer">componentize-py</a> is a tool authored by the Bytecode Alliance that allows you to produce WASI components that are authored in Python.
It has code generation suite that emits guest bindings in Python for any WIT specification you feed it.
It then takes your Python code written against these bindings and embeds them in a Wasm build of the Python interpreter to produce a component that supports the specified Wit.</p>
<p>Unsurprisingly, componentize-py relies on PyO3 and preopens itself in addition to <a href="https://github.com/dicej/component-init" target="_blank" rel="noopener noreferrer">component-init</a>, a solution to pre-intialize components up to a certain point for improved startup latencies.
This pre-intialization means we won&#x27;t need to provide the actual preopens for the resulting component, baking the <code>libpython</code> object code directly into it as PyO3 will have dynamically loaded the object code by that point.
Ultimately, this allows us to write all of our glue code in Python itself.</p>
<p>We still need a bit of Rust to support the <code>wit_wire</code> interface on the Typegate but this implementation is general across both the <code>PythonRuntime</code> and <code>WasmRuntime</code>.
We&#x27;d also moved to the <a href="https://wasmtime.dev/" target="_blank" rel="noopener noreferrer">Wasmtime</a>, also by Bytecode Alliance, for our wasm workloads at this point and their Rust bindings are a pleasure to use.
It&#x27;s all smooth sailing from here.</p>
<h2 class="anchor anchorWithStickyNavbar_gmPS" id="cloudy-skies">Cloudy skies?<a class="hash-link" aria-label="Direct link to Cloudy skies?" title="Direct link to Cloudy skies?" href="/blog/2024/08/26/python-on-webassembly#cloudy-skies">​</a></h2>
<p>A final stumbling block for this approach was the many seconds Wasmtime spends cooking all your CPU cores when it compiles the fat wasm module that contains the Python interpreter, Pyo3 bindings and more.
This happens because Wasmtime does&#x27;t (<a href="https://github.com/bytecodealliance/rfcs/blob/main/accepted/wasmtime-baseline-compilation.md" target="_blank" rel="noopener noreferrer">yet</a>) implement any schemes for tiered compilation, all code being greeted by their optimizing compiler, Cranelift.
And optimizations take time.
Sure, you only pay this cost the first time you load the Python runtime module as Wasmtime has great support for caching including on-disk caching.
But, 10+ second cold-starts, as measured on one developer&#x27;s machine, are unacceptable in a system that primarily serves HTTP requests.
What to do?</p>
<p>Wasmtime has just the feature for this problem, <a href="https://docs.wasmtime.dev/cli-options.html#compile" target="_blank" rel="noopener noreferrer">pre-compilation</a>.
Ahead-of-time compilation of wasm bytecode into a native instruction set.
Such files are commonly given the <code>.cwasm</code> extesion, <em>c</em> for compiled, and they are not a standalone executable but inteded to be run within Wasmtime&#x27;s sandbox.
This eliminates the compliation cost but the semantics of the source wasm bytecode and the runtime safe-guards means that this should be just as safe as JITting it (just-in-time compilation).
We then statically embed this pre-compiled wasm artifact, after compressing it, in the Typegate binary removing the need for sidecar files while ensuring minimal cold-starts for our python workloads.
To be concrete, this means <em>roughly</em> around 200 ms of overhead for a cold function and 5 ms for a warm one.
Good enough.</p>
<p>This post describes the technical journey we took to arrive to the current implementation of the <code>PythonRuntime</code>. Hopefully, all details were clear enough and please direct any feedback, questions, and thoughts to the comments down below and our Github issues/discussion board.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/metatypedev/metatype/tree/main/docs/metatype.dev/blog/2024-08-26-python-on-webassembly/index.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_YeJ5" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_dpzz"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/2024/08/27/distributed-execution-flow-paradigms"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Distributed execution flow paradigms</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2024/05/09/programmatic-deployment"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Programmatic deployment (v0.4.x)</div></a></nav></main><div class="col col--2"><div class="tableOfContents_tFzd thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/blog/2024/08/26/python-on-webassembly#why">Why?</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/2024/08/26/python-on-webassembly#what-are-the-requirements">What are the requirements?</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/2024/08/26/python-on-webassembly#an-aside-on-wasi">An aside on WASI</a><ul><li><a class="table-of-contents__link toc-highlight" href="/blog/2024/08/26/python-on-webassembly#file-system-access">File system access</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/2024/08/26/python-on-webassembly#wasi-02">WASI 0.2</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/blog/2024/08/26/python-on-webassembly#cloudy-skies">Cloudy skies?</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/tutorials/metatype-basics">Getting started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/concepts/features-overview">Features overview</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/concepts/mental-model">Concepts</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/reference/changelog">Changelog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/metatypedev/metatype/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_oKM7"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://communityinviter.com/apps/metatypedev/invite" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_oKM7"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/metatypedev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_oKM7"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/company/91505656/admin/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_oKM7"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Company</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/legal/terms">Terms &amp; conditions</a></li><li class="footer__item"><a class="footer__link-item" href="/legal/privacy-policy">Privacy policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © Metatype OÜ.</div></div></div></footer></div>
</body>
</html>