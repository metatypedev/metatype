(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[2829],{88572:(e,n,t)=>{"use strict";t.d(n,{Ay:()=>d,RM:()=>c});var i=t(86070),o=t(25710),s=t(65671),r=t(65480),a=t(27676);const c=[];function l(e){const n={a:"a",code:"code",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["Cross-Origin Resource Sharing (CORS) is a mechanism that allows or denies cross-origin requests in the browser. It prevents websites that you've not explicitly allowed from using your API. Note that it doesn't protect non-browser clients like server side code or a mobile app from using your typegraphs, only browsers implements the CORS mechanism. More details can be found ",(0,i.jsx)(n.a,{href:"https://developer.mozilla.org/en/docs/Web/HTTP/CORS",children:"here"}),"."]}),"\n",(0,i.jsxs)(r.Ay,{children:[(0,i.jsx)(a.A,{value:"typescript",children:(0,i.jsx)(s.A,{typegraph:"cors",typescript:t(66906),query:t(4489)})}),(0,i.jsx)(a.A,{value:"python",children:(0,i.jsx)(s.A,{typegraph:"cors",python:t(71388),query:t(4489)})})]}),"\n",(0,i.jsx)(n.p,{children:"If your browser support well CORS, you should the following error if you try to run the interactive demo."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "errors": [\n    {\n      "message": "NetworkError when attempting to fetch resource.",\n      "stack": ""\n    }\n  ]\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Look in the network tab of your browser inspect tools to see the error proper."}),"\n",(0,i.jsx)(n.p,{children:"By the way, there is a hidden cors header in all interactive demos you have met so far:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# ..\nCors(allow_origin=["https://metatype.dev", "http://localhost:3000"])\n# ..\n'})})]})}function d(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},23233:(e,n,t)=>{"use strict";t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>c,toc:()=>d});var i=t(86070),o=t(25710),s=(t(88572),t(27676),t(65671));const r={sidebar_position:50},a="Secure your requests",c={id:"guides/securing-requests/index",title:"Secure your requests",description:"Authentication",source:"@site/docs/guides/securing-requests/index.mdx",sourceDirName:"guides/securing-requests",slug:"/guides/securing-requests/",permalink:"/docs/guides/securing-requests/",draft:!1,unlisted:!1,editUrl:"https://github.com/metatypedev/metatype/tree/main/docs/metatype.dev/docs/guides/securing-requests/index.mdx",tags:[],version:"current",sidebarPosition:50,frontMatter:{sidebar_position:50},sidebar:"docs",previous:{title:"Write REST endpoints",permalink:"/docs/guides/rest/"},next:{title:"Wasm functions",permalink:"/docs/guides/wasm-functions/"}},l={},d=[{value:"Authentication",id:"authentication",level:2},{value:"Policies",id:"policies",level:2}];function u(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"secure-your-requests",children:"Secure your requests"}),"\n",(0,i.jsx)(n.h2,{id:"authentication",children:"Authentication"}),"\n",(0,i.jsx)(n.p,{children:"Typegraphs supports multiple auth schemes for incoming requests including:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/docs/reference/typegate/authentication#basic-authentication",children:"Basic access"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/docs/reference/typegate/authentication#jwt-authentication",children:"JSON Web Tokens (JWT)"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/docs/reference/typegate/authentication#oauth2-authorization",children:"OAuth2"})}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Each scheme relies on tokens that will be expected on the ",(0,i.jsx)(n.code,{children:"Authorization"})," header of any incoming request. Information extracted from any found tokens will then be added to the context of every request. Each scheme allows for different secrets to be encoded in the tokens, secrets like user identification and access tokens. You can then use ",(0,i.jsx)(n.a,{href:"/docs/reference/policies",children:"policies"})," to examine the context and determine if a request is allowed access to parts of your typegraph. You can also ",(0,i.jsx)(n.a,{href:"/docs/reference/types/injections",children:"inject"})," data from the context, to set materalizer inputs for example, using ",(0,i.jsx)(n.code,{children:"from_context"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["The following example uses basic authentication in order to only allow access for admin users. Basic authentication relies on a username and password pair. We specify the password through typegraph secrets with the format ",(0,i.jsx)(n.code,{children:"BASIC_{username}"}),". In this case, the secret ",(0,i.jsx)(n.code,{children:"BASIC_andim=password"})," is set."]}),"\n",(0,i.jsx)(s.A,{typegraph:"authentication",python:t(36310),typescript:t(37583),query:t(89280),headers:{Authorization:"Basic YW5kaW06cGFzc3dvcmQ="},tab:"headers"}),"\n",(0,i.jsxs)(n.p,{children:["Note, the token is encoded in base64. Decoded, it'd read ",(0,i.jsx)(n.code,{children:"andim:password"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["If you were to try to send a request without the header, you'd notice that ",(0,i.jsx)(n.code,{children:"get_full_context"})," still returns a result. An empty object. Authentication is only responsible for populating the context object and without a policy to shoot down the request, it'll access the materalizers."]}),"\n",(0,i.jsxs)(n.p,{children:["On the other hand, ",(0,i.jsx)(n.code,{children:"get_context"})," returns an empty object when no header is found. ",(0,i.jsx)(n.code,{children:"from_context"})," acts as guard preventing the materalizer from being accessed unless the named data is found in the context."]}),"\n",(0,i.jsxs)(n.p,{children:["More details about authentication can be found ",(0,i.jsx)(n.a,{href:"/docs/reference/typegate/authentication",children:"here"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"policies",children:"Policies"}),"\n",(0,i.jsxs)(n.p,{children:["The primary authorization paradigm used in typegraphs is ",(0,i.jsx)(n.a,{href:"/docs/reference/policies#policy-based-access-control-pbac",children:"policy based access control"}),". Policies are small pieces of logic that evaluate a request and determine whether access is allowed or not. They're attached to materalizers and are evaluated whenever a request tries to access the materalizer."]}),"\n",(0,i.jsxs)(n.p,{children:["Concretely, policies are implemented using ",(0,i.jsx)(n.a,{href:"/docs/guides/external-functions",children:"custom function"}),". These functions take the request's context object as input and return an optional bool. Typescript functions running on ",(0,i.jsx)(n.code,{children:"DenoRuntime"})," is the recommended way for writing policies today and the following example demonstrates how."]}),"\n",(0,i.jsx)(n.p,{children:"Before anything, the following secrets are required to enable the basic authentication scheme."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'typegates:\n  dev:\n    # ..\n    secrets:\n      policies:\n        BASIC_admin: "admin_pass"\n        BASIC_user: "user_pass"\n'})}),"\n",(0,i.jsx)(s.A,{typegraph:"policies",typescript:t(22481),python:t(85775),query:t(64722),headers:{Authorization:"Basic YWRtaW46YWRtaW5fcGFzcw=="},tab:"headers"}),"\n",(0,i.jsx)(n.p,{children:"More than one policy can be attached to a single materalizer and combining policies allows for compositionaly defining our access control rules. If a materalizer has more than one policy, they are evaluated in turn and:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If any one of attached policy returns ",(0,i.jsx)(n.code,{children:"true"}),", the request immediately gains access."]}),"\n",(0,i.jsxs)(n.li,{children:["If a policy returns ",(0,i.jsx)(n.code,{children:"false"}),", the request is immediately denied access."]}),"\n",(0,i.jsx)(n.li,{children:"If the policy means to defer decision to other attached policies, it can return null instead."}),"\n",(0,i.jsxs)(n.li,{children:["If all attached policies return ",(0,i.jsx)(n.code,{children:"null"}),", the request is denied access."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["There are helper functions on the ",(0,i.jsx)(n.code,{children:"Policy"})," object that allow easy construction of common policy patterns."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Policy.public"}),": allow any request."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Policy.internal"}),": allow requests originating from within typegraph like custom functions."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Policy.on"}),": use different policies depending on request effect. Useful for policy shared across many materalizers."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Policy.context"}),": generate a policy using a simple pattern matching on context object fields."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},65480:(e,n,t)=>{"use strict";t.d(n,{Ay:()=>r,gc:()=>a});t(30758);var i=t(3733),o=t(56315),s=t(86070);function r(e){let{children:n}=e;const[t,r]=(0,i.e)();return(0,s.jsx)(o.mS,{choices:{typescript:"Typescript SDK",python:"Python SDK"},choice:t,onChange:r,children:n})}function a(e){let{children:n}=e;const[t]=(0,i.e)();return(0,s.jsx)(o.q9,{choices:{typescript:"Typescript SDK",python:"Python SDK"},choice:t,children:n})}},65671:(e,n,t)=>{"use strict";t.d(n,{A:()=>s});var i=t(98302),o=(t(30758),t(86070));function s(e){let{python:n,typescript:t,rust:s,...r}=e;const a=[n&&{content:n.content,codeLanguage:"python",codeFileUrl:n.path},t&&{content:t.content,codeLanguage:"typescript",codeFileUrl:t.path},s&&{content:s.content,codeLanguage:"rust",codeFileUrl:s.path}].filter((e=>!!e));return(0,o.jsx)(i.A,{code:0==a.length?void 0:a,...r})}},89280:e=>{var n={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",variableDefinitions:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"get_full_context"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"get_context"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"username"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:62}};n.loc.source={body:"query {\n  get_full_context\n  get_context {\n    username\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function t(e,n){if("FragmentSpread"===e.kind)n.add(e.name.value);else if("VariableDefinition"===e.kind){var i=e.type;"NamedType"===i.kind&&n.add(i.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){t(e,n)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){t(e,n)})),e.definitions&&e.definitions.forEach((function(e){t(e,n)}))}var i={};n.definitions.forEach((function(e){if(e.name){var n=new Set;t(e,n),i[e.name.value]=n}})),e.exports=n},64722:e=>{var n={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"A"},variableDefinitions:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"public"},arguments:[],directives:[]}]}},{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"B"},variableDefinitions:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"admin_only"},arguments:[],directives:[]}]}},{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"C"},variableDefinitions:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"user_only"},arguments:[],directives:[]}]}},{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"D"},variableDefinitions:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"both"},arguments:[],directives:[]}]}}],loc:{start:0,end:92}};n.loc.source={body:"query A {\n  public\n}\n\nquery B {\n  admin_only\n}\n\nquery C {\n  user_only\n}\n\nquery D {\n  both\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function t(e,n){if("FragmentSpread"===e.kind)n.add(e.name.value);else if("VariableDefinition"===e.kind){var i=e.type;"NamedType"===i.kind&&n.add(i.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){t(e,n)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){t(e,n)})),e.definitions&&e.definitions.forEach((function(e){t(e,n)}))}var i={};function o(e,n){for(var t=0;t<e.definitions.length;t++){var i=e.definitions[t];if(i.name&&i.name.value==n)return i}}function s(e,n){var t={kind:e.kind,definitions:[o(e,n)]};e.hasOwnProperty("loc")&&(t.loc=e.loc);var s=i[n]||new Set,r=new Set,a=new Set;for(s.forEach((function(e){a.add(e)}));a.size>0;){var c=a;a=new Set,c.forEach((function(e){r.has(e)||(r.add(e),(i[e]||new Set).forEach((function(e){a.add(e)})))}))}return r.forEach((function(n){var i=o(e,n);i&&t.definitions.push(i)})),t}n.definitions.forEach((function(e){if(e.name){var n=new Set;t(e,n),i[e.name.value]=n}})),e.exports=n,e.exports.A=s(n,"A"),e.exports.B=s(n,"B"),e.exports.C=s(n,"C"),e.exports.D=s(n,"D")},4489:e=>{var n={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",variableDefinitions:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"catch_me_if_you_can"},arguments:[],directives:[]}]}}],loc:{start:0,end:75}};n.loc.source={body:"query {\n  catch_me_if_you_can\n  # the results panel should show an error\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function t(e,n){if("FragmentSpread"===e.kind)n.add(e.name.value);else if("VariableDefinition"===e.kind){var i=e.type;"NamedType"===i.kind&&n.add(i.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){t(e,n)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){t(e,n)})),e.definitions&&e.definitions.forEach((function(e){t(e,n)}))}var i={};n.definitions.forEach((function(e){if(e.name){var n=new Set;t(e,n),i[e.name.value]=n}})),e.exports=n},36310:e=>{e.exports={content:'deno = DenoRuntime()\nctx = t.struct({"username": t.string().optional()})\n\n# highlight-start\n# expects a secret in metatype.yml\n# `BASIC_[username]`\n# highlight-next-line\ng.auth(Auth.basic(["andim"]))\n# highlight-end\n\ng.expose(\n  Policy.public(),\n  get_context=deno.identity(ctx).apply(\n    {\n      "username": g.from_context("username"),\n    }\n  ),\n  get_full_context=deno.func(\n    t.struct({}),\n    t.string(),\n    code="(_: any, ctx: any) => Deno.inspect(ctx.context)",\n  ),\n)',path:"../examples/typegraphs/authentication.py"}},37583:e=>{e.exports={content:'const deno = new DenoRuntime();\n\nconst ctx = t.struct({\n  username: t.string().optional(),\n});\n\n// highlight-start\n// expects a secret in metatype.yml\n// `BASIC_[username]`\n// highlight-next-line\ng.auth(Auth.basic(["andim"]));\n// highlight-end\n\ng.expose(\n  {\n    get_context: deno.identity(ctx).apply({\n      username: g.fromContext("username"),\n    }),\n    get_full_context: deno.func(t.struct({}), t.string(), {\n      code: "(_: any, ctx: any) => Deno.inspect(ctx.context)",\n    }),\n  },\n  Policy.public(),\n);',path:"../examples/typegraphs/authentication.ts"}},71388:e=>{e.exports={content:'@typegraph(\n  # highlight-start\n  cors=Cors(\n    allow_origin=["https://not-this.domain"],\n    allow_headers=["x-custom-header"],\n    expose_headers=["header-1"],\n    allow_credentials=True,\n    max_age_sec=60,\n  ),\n  # highlight-end\n)\ndef cors(g: Graph):\n  random = RandomRuntime(seed=0, reset=None)\n\n  g.expose(\n    Policy.public(),\n    catch_me_if_you_can=random.gen(t.string()),\n  )',path:"../examples/typegraphs/cors.py"}},66906:e=>{e.exports={content:'await typegraph(\n  {\n    name: "cors",\n    // highlight-start\n    cors: {\n      allowOrigin: ["https://not-this.domain"],\n      allowHeaders: ["x-custom-header"],\n      exposeHeaders: ["header-1"],\n      allowCredentials: true,\n      maxAgeSec: 60,\n    },\n    // highlight-end\n  },\n  (g) => {\n    const random = new RandomRuntime({ seed: 0 });\n\n    g.expose(\n      {\n        catch_me_if_you_can: random.gen(t.string()),\n      },\n      Policy.public(),\n    );\n  },\n);',path:"../examples/typegraphs/cors.ts"}},85775:e=>{e.exports={content:'deno = DenoRuntime()\nrandom = RandomRuntime(seed=0, reset=None)\n\n# `public` is sugar for to `(_args, _ctx) => "PASS"`\npublic = Policy.public()\n\nadmin_only = deno.policy(\n  "admin_only",\n  # note: policies either return "ALLOW" | "DENY" | "PASS"\n  "(args, { context }) => context?.username === \'admin\' ? \'ALLOW\' : \'DENY\'",\n)\nuser_only = deno.policy(\n  "user_only",\n  "(args, { context }) => context?.username === \'user\' ? \'PASS\' : \'DENY\'",\n)\n\ng.auth(Auth.basic(["admin", "user"]))\n\ng.expose(\n  # set default policy for the exposed functions\n  Policy.public(),\n  public=random.gen(t.string()).with_policy(public),\n  admin_only=random.gen(t.string()).with_policy(admin_only),\n  user_only=random.gen(t.string()).with_policy(user_only),\n  # if both policies return null, access is denied\n  both=random.gen(t.string()).with_policy(user_only, admin_only),\n)',path:"../examples/typegraphs/policies.py"}},22481:e=>{e.exports={content:'const deno = new DenoRuntime();\nconst random = new RandomRuntime({ seed: 0 });\n// `public` is sugar for `(_args, _ctx) => "PASS"`\nconst pub = Policy.public();\n\nconst admin_only = deno.policy(\n  "admin_only",\n  // note: policies either return "ALLOW" | "DENY" | "PASS"\n  "(args, { context }) => context?.username === \'admin\' ? \'ALLOW\' : \'DENY\'",\n);\nconst user_only = deno.policy(\n  "user_only",\n  "(args, { context }) => context?.username === \'user\' ? \'PASS\' : \'DENY\'",\n);\n\ng.auth(Auth.basic(["admin", "user"]));\n\ng.expose(\n  {\n    public: random.gen(t.string()).withPolicy(pub),\n    admin_only: random.gen(t.string()).withPolicy(admin_only),\n    user_only: random.gen(t.string()).withPolicy(user_only),\n    // if both attached policies return null, access is denied\n    both: random.gen(t.string()).withPolicy([user_only, admin_only]),\n    // set default policy for the exposed functions\n  },\n  pub,\n);',path:"../examples/typegraphs/policies.ts"}}}]);