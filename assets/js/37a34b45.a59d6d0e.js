(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[9238],{17942:(e,t,n)=>{"use strict";n.d(t,{Zo:()=>u,kt:()=>h});var a=n(50959);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),p=c(n),m=r,h=p["".concat(s,".").concat(m)]||p[m]||d[m]||i;return n?a.createElement(h,o(o({ref:t},u),{},{components:n})):a.createElement(h,o({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[p]="string"==typeof e?e:r,o[1]=l;for(var c=2;c<i;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},43726:(e,t,n)=>{"use strict";n.d(t,{r:()=>r});var a=n(50959);function r(e){let{name:t,choices:n,choice:r,onChange:i,className:o}=e;return a.createElement("ul",{className:`pl-0 m-0 list-none w-full ${o??""}`},Object.entries(n).map((e=>{let[n,o]=e;return a.createElement("li",{key:n,className:"inline-block rounded-md overflow-clip mr-1"},a.createElement("div",null,a.createElement("label",{className:"cursor-pointer"},a.createElement("input",{type:"radio",name:t,value:n,checked:n===r,onChange:()=>i(n),className:"hidden peer"}),a.createElement("div",{className:"px-3 py-1 bg-slate-100 peer-checked:bg-metared peer-checked:text-white"},o))))})))}},66360:(e,t,n)=>{"use strict";n.d(t,{Z:()=>f});var a=n(50959),r=n(55362),i=n(90430),o=n(85551),l=n(90116),s=n(14623);const c=e=>{e.getWrapperElement().closest(".graphiql-editor").style.height=`${e.doc.height}px`};function u(e){const{queryEditor:t,variableEditor:n,headerEditor:r}=(0,s._i)({nonNull:!0}),[i,o]=(0,a.useState)(e.defaultTab),l=(0,s.Xd)({onCopyQuery:e.onCopyQuery}),u=(0,s.fE)();return(0,a.useEffect)((()=>{n&&c(n)}),[i,n]),(0,a.useEffect)((()=>{r&&c(r)}),[i,r]),(0,a.useEffect)((()=>{t&&(t.setOption("lineNumbers",!1),t.setOption("extraKeys",{"Alt-G":()=>{t.replaceSelection("@")}}),t.setOption("gutters",[]),t.on("change",c),c(t))}),[t]),(0,a.useEffect)((()=>{n&&(n.setOption("lineNumbers",!1),n.setOption("gutters",[]),n.on("change",c))}),[n]),(0,a.useEffect)((()=>{r&&(r.setOption("lineNumbers",!1),r.setOption("gutters",[]),r.on("change",c))}),[r]),a.createElement(s.u.Provider,null,a.createElement("div",{className:"graphiql-editors"},a.createElement("section",{className:"graphiql-query-editor shadow-sm","aria-label":"Query Editor"},a.createElement("div",{className:"graphiql-query-editor-wrapper"},a.createElement(s.WK,{editorTheme:e.editorTheme,keyMap:e.keyMap,onCopyQuery:e.onCopyQuery,onEdit:e.onEditQuery,readOnly:e.readOnly}),a.createElement("div",{className:"graphiql-toolbar",role:"toolbar","aria-label":"Editor Commands"},a.createElement(s._8,null),a.createElement(s.wC,{onClick:()=>u(),label:"Prettify query (Shift-Ctrl-P)"},a.createElement(s.Kt,{className:"graphiql-toolbar-icon","aria-hidden":"true"})),a.createElement(s.wC,{onClick:()=>l(),label:"Copy query (Shift-Ctrl-C)"},a.createElement(s.TI,{className:"graphiql-toolbar-icon","aria-hidden":"true"}))))),e.noTool?null:a.createElement(a.Fragment,null,a.createElement("div",{className:"graphiql-editor-tools p-0 text-sm "},a.createElement("div",{className:"graphiql-editor-tools-tabs"},a.createElement("div",{className:("variables"===i?"text-slate-800":"")+" p-2 hover:text-slate-800 cursor-pointer",onClick:()=>{o("variables"===i?"":"variables")}},"Variables"),a.createElement("div",{className:("headers"===i?"text-slate-800":"")+" p-2 hover:text-slate-800 cursor-pointer",onClick:()=>{o("headers"===i?"":"headers")}},"Headers"))),a.createElement("section",{className:"graphiql-editor-tool "+(i&&i.length>0?"pt-0":"hidden p-0"),"aria-label":"variables"===i?"Variables":"Headers"},a.createElement(s.hF,{editorTheme:e.editorTheme,isHidden:"variables"!==i,keyMap:e.keyMap,onEdit:e.onEditVariables,readOnly:e.readOnly}),a.createElement(s.LA,{editorTheme:e.editorTheme,isHidden:"headers"!==i,keyMap:e.keyMap,onEdit:e.onEditHeaders,readOnly:e.readOnly})))))}class p{constructor(){this.map=new Map,this.length=0}getItem(e){return this.map.get(e)}setItem(e,t){this.map.has(e)||(this.length+=1),this.map.set(e,t)}removeItem(e){this.map.has(e)&&(this.length-=1),this.map.delete(e)}clear(){this.length=0,this.map.clear()}}var d=n(43726);function m(){return(0,s.JB)({nonNull:!0}).isFetching?a.createElement(s.$j,null):null}const h={typegraph:"Typegraph",playground:"Playground"};function g(e){let{typegraph:t,query:n,code:i,codeLanguage:c,codeFileUrl:g,headers:f={},variables:y={},tab:b="",noTool:v=!1,defaultMode:E=null}=e;const{siteConfig:{customFields:{tgUrl:k}}}=(0,o.Z)(),x=(0,a.useMemo)((()=>new p),[]),N=(0,a.useMemo)((()=>(0,r.nq)({url:`${k}/${t}`})),[]),[O,w]=(0,a.useState)(E);return a.createElement("div",{className:"@container miniql mb-5"},E?a.createElement(d.r,{name:"mode",choices:h,choice:O,onChange:w,className:"mb-2"}):null,a.createElement(s.j$,{fetcher:N,defaultQuery:n.loc?.source.body.trim(),defaultHeaders:JSON.stringify(f),shouldPersistHeaders:!0,variables:JSON.stringify(y),storage:x},a.createElement("div",{className:(E?"":"md:grid @2xl:grid-cols-2")+" gap-2 w-full order-first"},E&&"typegraph"!==O?null:a.createElement("div",{className:" bg-slate-100 rounded-lg flex flex-col mb-2 md:mb-0"},g?a.createElement("div",{className:"p-2 text-xs font-light"},"See/edit full code on"," ",a.createElement("a",{href:`https://github.com/metatypedev/metatype/blob/main/${g}`},g)):null,i?a.createElement(l.Z,{language:c,wrap:!0,className:"flex-1"},i):null),E&&"playground"!==O?null:a.createElement("div",{className:"flex flex-col graphiql-container"},a.createElement("div",{className:"flex-1 graphiql-session"},a.createElement(u,{defaultTab:b,noTool:v})),a.createElement("div",{className:"flex-auto graphiql-response min-h-[200px] p-2 mt-2 bg-slate-100 rounded-lg"},a.createElement(m,null),a.createElement(s.iB,null))))))}function f(e){return a.createElement(i.Z,{fallback:a.createElement("div",null,"Loading...")},(()=>a.createElement(g,e)))}},31645:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var a=n(28957),r=n(66360),i=n(50959);function o(e){let{python:t,...n}=e;return i.createElement(r.Z,(0,a.Z)({code:t.content,codeLanguage:"python",codeFileUrl:t.path},n))}},67843:(e,t,n)=>{"use strict";n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>s,default:()=>h,frontMatter:()=>l,metadata:()=>c,toc:()=>p});var a=n(28957),r=(n(50959),n(17942)),i=n(90116),o=n(31645);const l={sidebar_position:7},s="Your chat app",c={unversionedId:"tutorials/your-chat-app/index",id:"tutorials/your-chat-app/index",title:"Your chat app",description:"Back to your typegraph for the chat-based app. You learn all keys components, and it's time to implement the business logic.",source:"@site/docs/tutorials/your-chat-app/index.mdx",sourceDirName:"tutorials/your-chat-app",slug:"/tutorials/your-chat-app/",permalink:"/docs/tutorials/your-chat-app/",draft:!1,editUrl:"https://github.com/metatypedev/metatype/tree/main/website/docs/tutorials/your-chat-app/index.mdx",tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7},sidebar:"docs",previous:{title:"Policies and materializers",permalink:"/docs/tutorials/policies-and-materializers/"},next:{title:"Authenticate your requests",permalink:"/docs/guides/authentication/"}},u={},p=[{value:"External typescript function",id:"external-typescript-function",level:2},{value:"Connecting the pieces together",id:"connecting-the-pieces-together",level:2}],d={toc:p},m="wrapper";function h(e){let{components:t,...l}=e;return(0,r.kt)(m,(0,a.Z)({},d,l,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"your-chat-app"},"Your chat app"),(0,r.kt)("p",null,"Back to your typegraph for the chat-based app. You learn all keys components, and it's time to implement the business logic."),(0,r.kt)("h2",{id:"external-typescript-function"},"External typescript function"),(0,r.kt)("p",null,"The Deno runtime can register external files for longer functions. You can use the meta CLI to generate the types once the ",(0,r.kt)("inlineCode",{parentName:"p"},"ModuleMat")," has been defined in your typegraph: ",(0,r.kt)("inlineCode",{parentName:"p"},"meta codegen deno -f typegraph.py"),"."),(0,r.kt)("p",null,"The external function offers three arguments:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"the first one is the arguments received as input"),(0,r.kt)("li",{parentName:"ul"},"the second one contains additional information about the request, including the context of the user"),(0,r.kt)("li",{parentName:"ul"},"the last one offers helpers functions to make authenticated calls to the same typegraph")),(0,r.kt)(i.Z,{language:"typescript",mdxType:"CodeBlock"},n(19578).content),(0,r.kt)("h2",{id:"connecting-the-pieces-together"},"Connecting the pieces together"),(0,r.kt)("p",null,"Take the learning of the last sections and use at your advantage the internal policies allowing to made calls within the Deno runtime and keeping the same context."),(0,r.kt)(o.Z,{typegraph:"business-logic",python:n(7887),query:n(54571),mdxType:"TGExample"}),(0,r.kt)("p",null,"That's it, you just developed chat-based API for your app - simple for sure, but covering most of the feature of Metatype."))}h.isMDXComponent=!0},54571:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",variableDefinitions:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"list_messages"},arguments:[{kind:"Argument",name:{kind:"Name",value:"take"},value:{kind:"IntValue",value:"2"}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"title"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:66}};t.loc.source={body:"query {\n  list_messages(take: 2) {\n    title\n  }\n\n  # your turn\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function n(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var a=e.type;"NamedType"===a.kind&&t.add(a.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){n(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){n(e,t)})),e.definitions&&e.definitions.forEach((function(e){n(e,t)}))}var a={};t.definitions.forEach((function(e){if(e.name){var t=new Set;n(e,t),a[e.name.value]=t}})),e.exports=t},7887:e=>{e.exports={content:'with TypeGraph(\n  "business-logic",\n  cors=TypeGraph.Cors(\n    allow_origin=[\n      "https://metatype.dev",\n      "http://localhost:3000",\n    ],\n  ),\n  auths=[\n    TypeGraph.Auth.basic(["admin", "user"]),\n  ],\n) as g:\n  db = PrismaRuntime("database", "POSTGRES_CONN")\n  gql = GraphQLRuntime("https://graphqlzero.almansi.me/api")\n  googleapi = import_googleapi()\n\n  public = policies.public()\n  gh_user = policies.ctx("user", "type")\n  # highlight-next-line\n  internal = policies.internal()\n\n  user = t.struct({"id": t.integer(), "name": t.string()})\n\n  message = t.struct(\n    {\n      "id": t.integer().as_id.config("auto"),\n      "title": t.string(),\n      "user_id": t.integer().named("uid"),\n      "user": gql.query(  # 1\n        t.struct(\n          {"id": t.integer().from_parent(g("uid"))}\n        ),  # 2\n        t.optional(user),\n      ),\n    }\n  ).named("message")\n\n  # highlight-start\n  g.expose(\n    list_messages=db.find_many(message),\n    emit_new_message=t.func(\n      t.struct({"title": t.string()}),\n      t.boolean(),\n      ModuleMat("business-logic.ts"),\n    ),\n    default_policy=[gh_user],\n  )\n  # highlight-end\n\n  g.expose(\n    create_message=db.create(message),\n    send_notification=googleapi.functions["projectsMessagesSend"],\n    list_users=gql.query(\n      t.struct({}), t.struct({"data": t.array(user)})\n    ),\n    default_policy=[internal],\n  )',path:"website/docs/tutorials/your-chat-app/business-logic.py"}},19578:e=>{e.exports={content:'// Copyright Metatype O\xdc, licensed under the Elastic License 2.0.\n// SPDX-License-Identifier: Elastic-2.0\n\n\nimport * as emoji from "https://deno.land/x/emoji@0.2.1/mod.ts";\n\ninterface ISend {\n  title: string;\n}\n\nexport default async function (\n  { title }: ISend,\n  { context },\n  { gql },\n): Promise<boolean> {\n  const text = `New message: ${title} from ${context.user.name} ${\n    emoji("coffee")\n  }`;\n\n  const messageQuery = gql`\n    mutation db($title: String!, $user_id: Int!) {\n      create_message(data: {title: $title, user_id: $user_id}) {\n        id\n      }\n    }\n  `;\n  const message = await messageQuery(\n    { title: text, user_id: context.user.id },\n  );\n  console.log(`created message ${message.data.db.create_message.id}`);\n\n  const notifQuery = gql`\n    mutation fcm {\n      send_notification\n    }\n  `;\n  const notif = await notifQuery();\n\n  console.log(`created notif ${notif.data.fcm.send_notification}`);\n  return true;\n}',path:"website/docs/tutorials/your-chat-app/scripts/deno/business-logic.ts"}}}]);