meta:
    workdir: .
    watches:
        - "meta-cli/src/**/*.rs"
    shell: "cargo run -p meta-cli -- --help"
    depends_on:
        - libs

examples:
    workdir: .
    watches:
        - "examples/metatype.yaml"
    shell: "cargo run -p meta-cli -- -C examples dev"
    envs:
        VIRTUAL_ENV: $PWD/examples/.venv
        PATH: $PWD/examples/.venv/bin:$PATH
    depends_on:
        - meta

system_graphs:
    workdir: typegate
    watches: src/typegraphs/*.py
    shell: "./serialize-tgs.sh"
    depends_on:
        - meta

typegate1:
    workdir: typegate
    watches: "src/**/*.ts"
    envs:
        TG_PORT: "7891"
        PACKAGED: "false"
        REQUEST_LOG: "tg1"
    shell: "./run.sh"
    depends_on:
        - clean_deno_bindgen_cache
        - typegate_native

typegate2:
    workdir: typegate
    watches: "src/**/*.ts"
    envs:
        TG_PORT: "7892"
        PACKAGED: "false"
        REQUEST_LOG: "tg2"
    shell: "./run.sh"
    depends_on:
        - clean_deno_bindgen_cache
        - typegate_native

libs:
    workdir: libs
    watches:
        - common/**/*.rs
        - typescript/**/*.rs
    shell: "cargo build -p common -p typescript"

codegen:
    depends_on:
        - libs
    workdir: .
    watches:
        - "libs/xtask/src/**/*.rs"
    envs:
        TG_JSONSCHEMA_OUT: website/static/typegraph.json
        TG_TYPESCRIPT_OUT: typegate/src/types/typegraph.ts
    shell: "cargo run --package xtask -- codegen"

clean_deno_bindgen_cache:
    shell: rm -rfv $(deno info --json | jq -r .denoDir)/plug/file
    depends_on:
        - typegate_native

typegate_native:
    watches:
        - "typegate/native/src/**/*.rs"
    envs:
        OUT_DIR: "target"
    shell: "deno_bindgen -- -p native"
    depends_on:
        - libs

website_deps:
    workdir: website
    watches: "package.json"
    shell: "pnpm install"

website:
    workdir: website
    shell: "pnpm start --no-open"
    envs:
        TG_URL: http://localhost:7890
    depends_on:
        - website_deps

website_meta:
    workdir: website
    shell: "cargo run -p meta-cli -- dev -u admin -p password --port 5001"
    depends_on:
        - meta
