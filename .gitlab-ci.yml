include:
  - project: "metatype/templates"
    ref: main
    file: "metatype.yml"
  - project: "devops/templates"
    ref: main
    file: "kaniko.yml"
  - project: "devops/templates"
    ref: main
    file: "terraform.yml"

variables: &variables
  DENO_VERSION: "1.22.0"
  DENO_BINDGEN_VERSION: "0.5.1"
  RUST_VERSION: "1.62.0"
  PNPM_VERSION: "7.5.2"

stages:
  - test
  - deploy

test:
  stage: test
  tags:
    - docker
  services:
    - name: postgres:14
      variables:
        POSTGRES_DB: db
        POSTGRES_PASSWORD: password
    - name: redis:7
      command:
        - --requirepass
        - password
  variables:
    <<: *variables
    TEST_POSTGRES_DB: "postgresql://postgres:password@postgres:5432/db?schema=test"

kaniko:
  stage: test
  tags:
    - docker
  only:
    - main
  variables:
    KANIKO_BUILD_CONTEXT: ./typegate
    KANIKO_EXTRA_ARGS: |
      --build-arg DENO_VERSION
      --build-arg DENO_BINDGEN_VERSION 
      --build-arg RUST_VERSION
      --build-arg VERSION=$TAG
      --use-new-run
      --single-snapshot

terraform:
  stage: deploy
  needs:
    - test
    - kaniko
  tags:
    - docker
  only:
    - main
  environment:
    name: production
  variables:
    TERRAFORM_PATH: "deploy/cloud/app"
